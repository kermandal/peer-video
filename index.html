<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Peer-to-Peer Video + Screen Share</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        margin: 0;
        padding: 10px;
    }
    h1 {
        text-align: center;
        margin-bottom: 10px;
    }
    .video-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 10px;
        margin-bottom: 20px;
    }
    .video-box {
        background: #fff;
        border-radius: 10px;
        padding: 5px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .video-box video {
        width: 100%;
        border-radius: 10px;
    }
    .label {
        font-size: 14px;
        font-weight: bold;
        margin-top: 5px;
    }
    .controls {
        text-align: center;
        margin: 10px 0;
    }
    button {
        padding: 10px 15px;
        margin: 5px;
        border: none;
        border-radius: 8px;
        background-color: #007bff;
        color: #fff;
        font-size: 14px;
        cursor: pointer;
    }
    button:hover {
        background-color: #0056b3;
    }
    input[type="text"] {
        width: 90%;
        margin: 5px 0;
        padding: 8px;
        font-size: 14px;
    }
    @media (max-width: 600px) {
        .video-grid {
            grid-template-columns: 1fr;
        }
        button {
            width: 90%;
        }
    }
</style>
</head>
<body>

<h1>Peer-to-Peer Video + Screen Share</h1>

<div class="video-grid">
    <div class="video-box">
        <video id="localVideo" autoplay playsinline></video>
        <div class="label">Local Camera</div>
    </div>
    <div class="video-box">
        <video id="localScreen" autoplay playsinline></video>
        <div class="label">Local Screen</div>
    </div>
    <div class="video-box">
        <video id="remoteVideo" autoplay playsinline></video>
        <div class="label">Remote Camera</div>
    </div>
    <div class="video-box">
        <video id="remoteScreen" autoplay playsinline></video>
        <div class="label">Remote Screen</div>
    </div>
</div>

<div class="controls">
    <button id="muteAudio">Mute</button>
    <button id="shareScreen">Start Screen Share</button>
</div>

<hr/>

<div>
    <p>
        <strong>Host:</strong>
        <button id="createOffer">Create Offer</button><br/>
        <input type="text" id="localOffer" placeholder="Local Offer"/>
        <br/>Paste remote answer:
        <input type="text" id="remoteAnswer" placeholder="Remote Answer"/>
        <button id="acceptAnswer">Accept Answer</button>
    </p>
    <p>
        <strong>Remote:</strong><br/>
        Paste host offer:
        <input type="text" id="remoteOffer" placeholder="Remote Offer"/>
        <button id="acceptOffer">Accept Offer</button><br/>
        Copy your answer:
        <input type="text" id="localAnswer" placeholder="Local Answer"/>
    </p>
</div>

<script>
'use strict';

const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
const offerOptions = { offerToReceiveVideo: 1, offerToReceiveAudio: 1 };

const localVideo = document.getElementById('localVideo');
const localScreen = document.getElementById('localScreen');
const remoteVideo = document.getElementById('remoteVideo');
const remoteScreen = document.getElementById('remoteScreen');

const localOffer = document.getElementById('localOffer');
const remoteOffer = document.getElementById('remoteOffer');
const createOffer = document.getElementById('createOffer');
const acceptOffer = document.getElementById('acceptOffer');

const localAnswer = document.getElementById('localAnswer');
const remoteAnswer = document.getElementById('remoteAnswer');
const acceptAnswer = document.getElementById('acceptAnswer');

const shareScreenBtn = document.getElementById('shareScreen');
const muteAudioBtn = document.getElementById('muteAudio');

let peerConnection = new RTCPeerConnection(servers);
console.log('Created peer connection');

let peerMediaStream = new MediaStream();
peerConnection.addStream(peerMediaStream);

peerConnection.addEventListener('icecandidate', handleConnection);
peerConnection.addEventListener('addstream', gotRemoteMediaStream);

let localStream;
let audioMuted = false;
let screenStream;
let isSharingScreen = false;

// 1. Get camera + audio stream
navigator.mediaDevices.getUserMedia({ video: true, audio: true })
.then((mediaStream) => {
    localVideo.srcObject = mediaStream;
    localStream = mediaStream;
    for (const track of mediaStream.getTracks()) {
        peerMediaStream.addTrack(track);
    }
})
.catch(logError);

// 2. Screen Share Toggle
shareScreenBtn.addEventListener('click', async () => {
    if (!isSharingScreen) {
        try {
            screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            localScreen.srcObject = screenStream;

            for (const track of screenStream.getTracks()) {
                peerMediaStream.addTrack(track);
            }
            shareScreenBtn.textContent = "Stop Screen Share";
            isSharingScreen = true;

            screenStream.getVideoTracks()[0].onended = () => {
                stopScreenShare();
            };
        } catch (err) {
            logError(err);
        }
    } else {
        stopScreenShare();
    }
});

function stopScreenShare() {
    if (screenStream) {
        screenStream.getTracks().forEach(track => track.stop());
        localScreen.srcObject = null;
    }
    shareScreenBtn.textContent = "Start Screen Share";
    isSharingScreen = false;
}

// 3. Mute/Unmute Audio
muteAudioBtn.addEventListener('click', () => {
    if (!localStream) return;
    audioMuted = !audioMuted;
    localStream.getAudioTracks().forEach(track => track.enabled = !audioMuted);
    muteAudioBtn.textContent = audioMuted ? "Unmute" : "Mute";
});

// Create Offer
createOffer.addEventListener('click', () => {
    peerConnection.createOffer(offerOptions)
        .then(createdOffer)
        .catch(logError);
});

function createdOffer(description) {
    peerConnection.setLocalDescription(description)
        .then(() => console.log('Local peer description set'))
        .catch(logError);
}

// Accept Offer (Remote)
acceptOffer.addEventListener('click', () => {
    const description = JSON.parse(remoteOffer.value);
    peerConnection.setRemoteDescription(description)
        .then(() => console.log('Remote peer offer accepted'))
        .catch(logError);

    peerConnection.createAnswer()
        .then(createdAnswer)
        .catch(logError);
});

function createdAnswer(description) {
    peerConnection.setLocalDescription(description)
        .then(() => console.log('Remote peer answered'))
        .catch(logError);
}

// Accept Answer (Host)
acceptAnswer.addEventListener('click', () => {
    const description = JSON.parse(remoteAnswer.value);
    peerConnection.setRemoteDescription(description)
        .then(() => console.log('Local peer remote description set'))
        .catch(logError);
});

// Handle ICE
function handleConnection(event) {
    const connection = event.target;
    const iceCandidate = event.candidate;

    if (iceCandidate == null) {
        const description = connection.localDescription;
        const descriptionString = JSON.stringify(description);

        if (description.type === 'offer') {
            localOffer.value = descriptionString;
        } else {
            localAnswer.value = descriptionString;
        }
    }
}

// Show Remote Streams
function gotRemoteMediaStream(event) {
    const mediaStream = event.stream;
    console.log('Remote peer connection received remote stream');

    const videoTracks = mediaStream.getVideoTracks();
    if (videoTracks.length > 1) {
        remoteVideo.srcObject = new MediaStream([videoTracks[0]]);
        remoteScreen.srcObject = new MediaStream([videoTracks[1]]);
    } else {
        remoteVideo.srcObject = mediaStream;
    }
}

function logError(error) {
    console.error(error);
}
</script>
</body>
</html>
