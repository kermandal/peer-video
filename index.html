<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Peer-to-Peer Video + Screen Share</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        margin: 0;
        padding: 10px;
    }
    h1 {
        text-align: center;
        margin-bottom: 10px;
    }
    .video-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 10px;
        margin-bottom: 20px;
    }
    .video-box {
        background: #fff;
        border-radius: 10px;
        padding: 5px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .video-box video {
        width: 100%;
        border-radius: 10px;
    }
    .label {
        font-size: 14px;
        font-weight: bold;
        margin-top: 5px;
    }
    .controls {
        text-align: center;
        margin: 10px 0;
    }
    button {
        padding: 10px 15px;
        margin: 5px;
        border: none;
        border-radius: 8px;
        background-color: #007bff;
        color: #fff;
        font-size: 14px;
        cursor: pointer;
    }
    button:hover {
        background-color: #0056b3;
    }
    input[type="text"] {
        width: 90%;
        margin: 5px 0;
        padding: 8px;
        font-size: 14px;
    }
    #status {
        text-align: center;
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
    }
    @media (max-width: 600px) {
        .video-grid {
            grid-template-columns: 1fr;
        }
        button {
            width: 90%;
        }
    }
</style>
</head>
<body>

<h1>Peer-to-Peer Video + Screen Share</h1>
<p id="status">Status: Not Connected</p>

<div class="video-grid">
    <div class="video-box">
        <video id="localVideo" autoplay playsinline muted></video>
        <div class="label">Local Camera</div>
    </div>
    <div class="video-box">
        <video id="localScreen" autoplay playsinline></video>
        <div class="label">Local Screen</div>
    </div>
    <div class="video-box">
        <video id="remoteVideo" autoplay playsinline></video>
        <div class="label">Remote Camera</div>
    </div>
    <div class="video-box">
        <video id="remoteScreen" autoplay playsinline></video>
        <div class="label">Remote Screen</div>
    </div>
</div>

<div class="controls">
    <button id="muteAudio">Mute</button>
    <button id="shareScreen">Start Screen Share</button>
</div>

<hr/>

<div>
    <p>
        <strong>Host:</strong>
        <button id="createOffer">Create Offer</button><br/>
        <input type="text" id="localOffer" placeholder="Local Offer"/>
        <br/>Paste remote answer:
        <input type="text" id="remoteAnswer" placeholder="Remote Answer"/>
        <button id="acceptAnswer">Accept Answer</button>
    </p>
    <p>
        <strong>Remote:</strong><br/>
        Paste host offer:
        <input type="text" id="remoteOffer" placeholder="Remote Offer"/>
        <button id="acceptOffer">Accept Offer</button><br/>
        Copy your answer:
        <input type="text" id="localAnswer" placeholder="Local Answer"/>
    </p>
</div>

<script>
'use strict';

const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
const offerOptions = { offerToReceiveVideo: true, offerToReceiveAudio: true };

const localVideo = document.getElementById('localVideo');
const localScreen = document.getElementById('localScreen');
const remoteVideo = document.getElementById('remoteVideo');
const remoteScreen = document.getElementById('remoteScreen');

const localOffer = document.getElementById('localOffer');
const remoteOffer = document.getElementById('remoteOffer');
const createOffer = document.getElementById('createOffer');
const acceptOffer = document.getElementById('acceptOffer');

const localAnswer = document.getElementById('localAnswer');
const remoteAnswer = document.getElementById('remoteAnswer');
const acceptAnswer = document.getElementById('acceptAnswer');

const shareScreenBtn = document.getElementById('shareScreen');
const muteAudioBtn = document.getElementById('muteAudio');

const statusElement = document.getElementById('status');

let pc = new RTCPeerConnection(servers);
let localStream;
let screenStream;
let audioMuted = false;
let isSharingScreen = false;

function updateStatus(message, color = "#333") {
    statusElement.textContent = "Status: " + message;
    statusElement.style.color = color;
}

// Initial status
updateStatus("Initializing...");

// Monitor connection state
pc.onconnectionstatechange = () => {
    const state = pc.connectionState;
    if (state === "connected") {
        updateStatus("Connected ✅", "green");
    } else if (state === "disconnected" || state === "failed") {
        updateStatus("Disconnected ❌", "red");
    } else if (state === "connecting") {
        updateStatus("Connecting...", "orange");
    } else {
        updateStatus(state);
    }
};

// Handle remote tracks
pc.ontrack = (event) => {
    const stream = event.streams[0];
    const videoTracks = stream.getVideoTracks();

    if (videoTracks.length > 1) {
        remoteVideo.srcObject = new MediaStream([videoTracks[0]]);
        remoteScreen.srcObject = new MediaStream([videoTracks[1]]);
    } else {
        remoteVideo.srcObject = stream;
    }
};

// ICE candidate handling
pc.onicecandidate = (event) => {
    if (event.candidate === null) {
        const description = pc.localDescription;
        const json = JSON.stringify(description);
        if (description.type === 'offer') {
            localOffer.value = json;
        } else {
            localAnswer.value = json;
        }
    }
};

// Get local media
navigator.mediaDevices.getUserMedia({ video: true, audio: true })
.then(stream => {
    updateStatus("Local camera ready", "blue");
    localStream = stream;
    localVideo.srcObject = stream;

    stream.getTracks().forEach(track => pc.addTrack(track, stream));
})
.catch(err => {
    updateStatus("Error: " + err.message, "red");
});

// Create Offer
createOffer.addEventListener('click', async () => {
    updateStatus("Creating offer...", "orange");
    const offer = await pc.createOffer(offerOptions);
    await pc.setLocalDescription(offer);
    updateStatus("Offer created, send it to remote", "blue");
});

// Accept Offer (Remote)
acceptOffer.addEventListener('click', async () => {
    updateStatus("Accepting remote offer...", "orange");
    const desc = JSON.parse(remoteOffer.value);
    await pc.setRemoteDescription(desc);

    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    updateStatus("Answer created, send it to host", "blue");
});

// Accept Answer (Host)
acceptAnswer.addEventListener('click', async () => {
    updateStatus("Accepting answer...", "orange");
    const desc = JSON.parse(remoteAnswer.value);
    await pc.setRemoteDescription(desc);
    updateStatus("Waiting for connection...", "orange");
});

// Mute / Unmute Audio
muteAudioBtn.addEventListener('click', () => {
    if (!localStream) return;
    audioMuted = !audioMuted;
    localStream.getAudioTracks().forEach(track => track.enabled = !audioMuted);
    muteAudioBtn.textContent = audioMuted ? "Unmute" : "Mute";
});

// Start / Stop Screen Share
shareScreenBtn.addEventListener('click', async () => {
    if (!isSharingScreen) {
        try {
            screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            localScreen.srcObject = screenStream;

            screenStream.getTracks().forEach(track => pc.addTrack(track, screenStream));

            isSharingScreen = true;
            shareScreenBtn.textContent = "Stop Screen Share";

            screenStream.getVideoTracks()[0].onended = () => stopScreenShare();
        } catch (err) {
            console.error(err);
        }
    } else {
        stopScreenShare();
    }
});

function stopScreenShare() {
    if (screenStream) {
        screenStream.getTracks().forEach(track => track.stop());
        localScreen.srcObject = null;
    }
    shareScreenBtn.textContent = "Start Screen Share";
    isSharingScreen = false;
}
</script>
</body>
</html>
