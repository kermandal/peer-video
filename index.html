<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>P2P Zoom-Style Call</title>
  <style>
    body { 
      font-family: system-ui, sans-serif; 
      background: #111; 
      color: white;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      text-align: center;
      padding: 10px;
      background: #222;
      font-weight: bold;
    }
    .videos {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 5px;
      padding: 5px;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
      background: black;
    }
    /* Floating bottom bar */
    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px;
      gap: 15px;
    }
    .control-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      font-size: 22px;
      font-weight: bold;
      cursor: pointer;
      background: #444;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: 0.2s;
    }
    .control-btn.active { background: #0077ff; }
    .control-btn.danger { background: #e53935; }
    .control-btn:hover { opacity: 0.9; }
    textarea {
      width: 100%;
      height: 60px;
      font-family: monospace;
      font-size: 12px;
      margin: 5px 0;
    }
    .signaling {
      background: #222;
      padding: 8px;
    }

    /* üì± Mobile adjustments */
    @media (max-width: 768px) {
      .videos { grid-template-columns: 1fr; }
      .control-btn { width: 50px; height: 50px; font-size: 18px; }
    }
  </style>
</head>
<body>
  <header>Zoom-Style P2P Call</header>

  <div class="videos">
    <video id="localVideo" autoplay playsinline muted></video>
    <video id="localScreen" autoplay playsinline muted></video>
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="remoteScreen" autoplay playsinline></video>
  </div>

  <!-- Floating controls -->
  <div class="controls">
    <button id="btnCamera" class="control-btn active" onclick="toggleCamera()">üì∑</button>
    <button id="btnMic" class="control-btn active" onclick="toggleMic()">üé§</button>
    <button id="btnScreen" class="control-btn" onclick="toggleScreen()">üñ•Ô∏è</button>
  </div>

  <!-- Manual signaling (hidden in real app, but needed here) -->
  <div class="signaling">
    <button onclick="createOffer()">Create Offer (Host)</button>
    <button onclick="acceptOffer()">Accept Offer / Answer</button>
    <textarea id="localSDP" placeholder="Your SDP will appear here"></textarea>
    <textarea id="remoteSDP" placeholder="Paste remote SDP here"></textarea>
  </div>

  <script>
    const localVideo = document.getElementById("localVideo");
    const localScreen = document.getElementById("localScreen");
    const remoteVideo = document.getElementById("remoteVideo");
    const remoteScreen = document.getElementById("remoteScreen");

    const localSDP = document.getElementById("localSDP");
    const remoteSDP = document.getElementById("remoteSDP");

    const btnCamera = document.getElementById("btnCamera");
    const btnMic = document.getElementById("btnMic");
    const btnScreen = document.getElementById("btnScreen");

    const pc = new RTCPeerConnection();
    let camStream, screenStream;
    let micEnabled = true;
    let camEnabled = true;

    // === Handle incoming remote tracks ===
    pc.ontrack = (event) => {
      if (event.track.kind === "video") {
        if (!remoteVideo.srcObject) {
          remoteVideo.srcObject = event.streams[0];
        } else {
          remoteScreen.srcObject = event.streams[0];
        }
      } else if (event.track.kind === "audio") {
        const audio = document.createElement("audio");
        audio.srcObject = event.streams[0];
        audio.autoplay = true;
      }
    };

    // === Camera toggle ===
    async function toggleCamera() {
      if (!camStream) {
        try {
          camStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
          localVideo.srcObject = camStream;
          camStream.getTracks().forEach(track => pc.addTrack(track, camStream));
          camEnabled = true;
          btnCamera.classList.add("active");
        } catch (err) {
          console.error("Camera error:", err);
        }
        return;
      }

      camEnabled = !camEnabled;
      camStream.getVideoTracks().forEach(track => track.enabled = camEnabled);
      btnCamera.classList.toggle("active", camEnabled);
    }

    // === Mic toggle ===
    function toggleMic() {
      if (!camStream) {
        alert("Start the camera first!");
        return;
      }
      micEnabled = !micEnabled;
      camStream.getAudioTracks().forEach(track => track.enabled = micEnabled);
      btnMic.classList.toggle("active", micEnabled);
    }

    // === Screen toggle ===
    async function toggleScreen() {
      if (!screenStream) {
        try {
          screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
          localScreen.srcObject = screenStream;
          screenStream.getTracks().forEach(track => pc.addTrack(track, screenStream));
          btnScreen.classList.add("active");
          screenStream.getVideoTracks()[0].onended = () => toggleScreen(); // auto-stop if user ends share
        } catch (err) {
          console.error("Screen share error:", err);
        }
      } else {
        screenStream.getTracks().forEach(track => track.stop());
        localScreen.srcObject = null;
        screenStream = null;
        btnScreen.classList.remove("active");
      }
    }

    // === Offer / Answer flow ===
    async function createOffer() {
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      localSDP.value = JSON.stringify(offer);
    }

    async function acceptOffer() {
      const sdp = JSON.parse(remoteSDP.value);
      await pc.setRemoteDescription(new RTCSessionDescription(sdp));
      if (sdp.type === "offer") {
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        localSDP.value = JSON.stringify(answer);
      }
    }
  </script>
</body>
</html>
